# æ–‡ä»¶å­˜å‚¨æœåŠ¡é…ç½®æ–‡æ¡£

## ğŸ“‹ ç›®å½•

- [é…ç½®æ¦‚è¿°](#é…ç½®æ¦‚è¿°)
- [ä¸ƒç‰›äº‘å­˜å‚¨é…ç½®](#ä¸ƒç‰›äº‘å­˜å‚¨é…ç½®)
- [æœ¬åœ°å­˜å‚¨é…ç½®](#æœ¬åœ°å­˜å‚¨é…ç½®)
- [é€šç”¨é…ç½®é¡¹](#é€šç”¨é…ç½®é¡¹)
- [é…ç½®ç¤ºä¾‹](#é…ç½®ç¤ºä¾‹)
- [ç¯å¢ƒåˆ‡æ¢](#ç¯å¢ƒåˆ‡æ¢)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ğŸ”§ é…ç½®æ¦‚è¿°

æ–‡ä»¶å­˜å‚¨æœåŠ¡æ”¯æŒå¤šç§å­˜å‚¨ç­–ç•¥ï¼Œé€šè¿‡é…ç½®æ–‡ä»¶è¿›è¡Œçµæ´»åˆ‡æ¢ã€‚ç³»ç»Ÿä¼šæ ¹æ® `storage.type` é…ç½®é¡¹è‡ªåŠ¨é€‰æ‹©å¯¹åº”çš„å­˜å‚¨å®ç°ã€‚

### æ”¯æŒçš„å­˜å‚¨ç±»å‹

- **qiniu** - ä¸ƒç‰›äº‘å­˜å‚¨ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
- **local** - æœ¬åœ°ç£ç›˜å­˜å‚¨ï¼ˆå¼€å‘ç¯å¢ƒæ¨èï¼‰
- **aliyun** - é˜¿é‡Œäº‘ OSSï¼ˆæœªæ¥æ‰©å±•ï¼‰

---

## â˜ï¸ ä¸ƒç‰›äº‘å­˜å‚¨é…ç½®

### åŸºç¡€é…ç½®ç¤ºä¾‹

```yaml
# application.yml
storage:
  type: qiniu
  max-file-size: 10485760 # 10MB
  allowed-types:
    - jpg
    - jpeg
    - png
    - gif
    - pdf
    - doc
    - docx
    - txt
  qiniu:
    access-key: ${QINIU_ACCESS_KEY:your-access-key}
    secret-key: ${QINIU_SECRET_KEY:your-secret-key}
    bucket: ${QINIU_BUCKET:your-bucket-name}
    domain: ${QINIU_DOMAIN:your-domain.com}
    region: åå—
    use-https: true
    url-expire-seconds: 3600
```

### é…ç½®é¡¹è¯´æ˜

| é…ç½®é¡¹               | ç±»å‹    | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜                                 |
| -------------------- | ------- | ---- | ------ | ------------------------------------ |
| `access-key`         | String  | æ˜¯   | -      | ä¸ƒç‰›äº‘ AccessKey                     |
| `secret-key`         | String  | æ˜¯   | -      | ä¸ƒç‰›äº‘ SecretKey                     |
| `bucket`             | String  | æ˜¯   | -      | å­˜å‚¨ç©ºé—´åç§°                         |
| `domain`             | String  | æ˜¯   | -      | CDN åŠ é€ŸåŸŸå                         |
| `region`             | String  | å¦   | åå—   | å­˜å‚¨åŒºåŸŸï¼šåä¸œ/ååŒ—/åå—/åŒ—ç¾/ä¸œå—äºš |
| `use-https`          | Boolean | å¦   | true   | æ˜¯å¦ä½¿ç”¨ HTTPS è®¿é—®                  |
| `url-expire-seconds` | Long    | å¦   | 3600   | ç§æœ‰æ–‡ä»¶ URL è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰          |

### ç¯å¢ƒå˜é‡é…ç½®

æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®æ•æ„Ÿä¿¡æ¯ï¼š

```bash
# ç¯å¢ƒå˜é‡è®¾ç½®
export QINIU_ACCESS_KEY="your-access-key"
export QINIU_SECRET_KEY="your-secret-key"
export QINIU_BUCKET="your-bucket-name"
export QINIU_DOMAIN="your-domain.com"
```

---

## ğŸ’¾ æœ¬åœ°å­˜å‚¨é…ç½®

### åŸºç¡€é…ç½®ç¤ºä¾‹

```yaml
# application.yml
storage:
  type: local
  max-file-size: 52428800 # 50MB
  allowed-types:
    - jpg
    - jpeg
    - png
    - gif
    - pdf
    - doc
    - docx
    - txt
    - zip
  local:
    root-path: ${LOCAL_STORAGE_PATH:./uploads}
    url-prefix: /uploads
    create-date-dir: true
```

### é…ç½®é¡¹è¯´æ˜

| é…ç½®é¡¹            | ç±»å‹    | å¿…å¡« | é»˜è®¤å€¼    | è¯´æ˜                 |
| ----------------- | ------- | ---- | --------- | -------------------- |
| `root-path`       | String  | æ˜¯   | ./uploads | æ–‡ä»¶å­˜å‚¨æ ¹ç›®å½•       |
| `url-prefix`      | String  | æ˜¯   | /uploads  | è®¿é—® URL å‰ç¼€        |
| `create-date-dir` | Boolean | å¦   | true      | æ˜¯å¦åˆ›å»ºæ—¥æœŸç›®å½•ç»“æ„ |

### é™æ€èµ„æºé…ç½®

é…åˆ Spring Boot é™æ€èµ„æºé…ç½®ï¼š

```yaml
# application.yml
spring:
  web:
    resources:
      static-locations:
        - classpath:/static/
        - file:./uploads/
```

---

## âš™ï¸ é€šç”¨é…ç½®é¡¹

### æ–‡ä»¶é™åˆ¶é…ç½®

```yaml
storage:
  max-file-size: 10485760 # æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆå­—èŠ‚ï¼‰
  allowed-types: # å…è®¸çš„æ–‡ä»¶æ‰©å±•å
    - jpg
    - jpeg
    - png
    - gif
    - bmp
    - webp
    - pdf
    - doc
    - docx
    - xls
    - xlsx
    - ppt
    - pptx
    - txt
    - zip
    - rar
```

### å¤§å°é™åˆ¶è¯´æ˜

| å€¼        | å¤§å°  | é€‚ç”¨åœºæ™¯         |
| --------- | ----- | ---------------- |
| 1048576   | 1MB   | å¤´åƒã€å°å›¾ç‰‡     |
| 5242880   | 5MB   | ä¸€èˆ¬å›¾ç‰‡ã€æ–‡æ¡£   |
| 10485760  | 10MB  | é«˜æ¸…å›¾ç‰‡ã€å°è§†é¢‘ |
| 52428800  | 50MB  | å¤§æ–‡æ¡£ã€å‹ç¼©åŒ…   |
| 104857600 | 100MB | è§†é¢‘æ–‡ä»¶         |

---

## ğŸ“‹ é…ç½®ç¤ºä¾‹

### å¼€å‘ç¯å¢ƒé…ç½®

```yaml
# application-dev.yml
storage:
  type: local
  max-file-size: 52428800 # 50MBï¼Œå¼€å‘ç¯å¢ƒå¯ä»¥å®½æ¾ä¸€äº›
  allowed-types:
    - jpg
    - jpeg
    - png
    - gif
    - pdf
    - doc
    - docx
    - txt
    - zip
  local:
    root-path: ./dev-uploads
    url-prefix: /uploads
    create-date-dir: true

# æ—¥å¿—é…ç½®
logging:
  level:
    pw.pj.service.impl.LocalStorageServiceImpl: DEBUG
    pw.pj.common.config.FileStorageConfig: DEBUG
```

### æµ‹è¯•ç¯å¢ƒé…ç½®

```yaml
# application-test.yml
storage:
  type: qiniu
  max-file-size: 10485760 # 10MB
  allowed-types:
    - jpg
    - jpeg
    - png
    - gif
    - pdf
  qiniu:
    access-key: ${QINIU_TEST_ACCESS_KEY}
    secret-key: ${QINIU_TEST_SECRET_KEY}
    bucket: ${QINIU_TEST_BUCKET}
    domain: ${QINIU_TEST_DOMAIN}
    region: åå—
    use-https: true
```

### ç”Ÿäº§ç¯å¢ƒé…ç½®

```yaml
# application-prod.yml
storage:
  type: qiniu
  max-file-size: 10485760 # 10MBï¼Œç”Ÿäº§ç¯å¢ƒé™åˆ¶ä¸¥æ ¼
  allowed-types:
    - jpg
    - jpeg
    - png
    - gif
    - pdf
    - doc
    - docx
  qiniu:
    access-key: ${QINIU_ACCESS_KEY}
    secret-key: ${QINIU_SECRET_KEY}
    bucket: ${QINIU_BUCKET}
    domain: ${QINIU_DOMAIN}
    region: åå—
    use-https: true
    url-expire-seconds: 1800 # 30åˆ†é’Ÿ

# å®‰å…¨é…ç½®
logging:
  level:
    pw.pj.service.impl.QiniuStorageServiceImpl: WARN
    pw.pj.common.config.FileStorageConfig: INFO
```

---

## ğŸ”„ ç¯å¢ƒåˆ‡æ¢

### æ–¹æ³•ä¸€ï¼šProfile é…ç½®

```bash
# å¯åŠ¨æ—¶æŒ‡å®šç¯å¢ƒ
java -jar app.jar --spring.profiles.active=prod

# æˆ–ä½¿ç”¨ç¯å¢ƒå˜é‡
export SPRING_PROFILES_ACTIVE=prod
```

### æ–¹æ³•äºŒï¼šé…ç½®è¦†ç›–

```bash
# å¯åŠ¨æ—¶è¦†ç›–é…ç½®
java -jar app.jar --storage.type=qiniu --storage.qiniu.bucket=prod-bucket
```

### æ–¹æ³•ä¸‰ï¼šå¤–éƒ¨é…ç½®æ–‡ä»¶

```bash
# æŒ‡å®šå¤–éƒ¨é…ç½®æ–‡ä»¶
java -jar app.jar --spring.config.location=file:./config/application.yml
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•åœ¨å¼€å‘ç¯å¢ƒä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨ä¸ƒç‰›äº‘ï¼Ÿ

**A:** ä½¿ç”¨ Spring Profile é…ç½®ï¼š

```yaml
# application-dev.yml
storage:
  type: local

# application-prod.yml
storage:
  type: qiniu
```

### Q2: æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œæç¤º"é…ç½®éªŒè¯å¤±è´¥"ï¼Ÿ

**A:** æ£€æŸ¥å¿…å¡«é…ç½®é¡¹ï¼š

1. ä¸ƒç‰›äº‘ï¼šç¡®ä¿ `access-key`ã€`secret-key`ã€`bucket`ã€`domain` å·²é…ç½®
2. æœ¬åœ°å­˜å‚¨ï¼šç¡®ä¿ `root-path` å·²é…ç½®ä¸”ç›®å½•å¯å†™

### Q3: å¦‚ä½•æ”¯æŒæ›´å¤§çš„æ–‡ä»¶ä¸Šä¼ ï¼Ÿ

**A:** åŒæ—¶é…ç½®ä»¥ä¸‹é¡¹ï¼š

```yaml
storage:
  max-file-size: 104857600 # 100MB

spring:
  servlet:
    multipart:
      max-file-size: 100MB
      max-request-size: 100MB
```

### Q4: å¦‚ä½•æ·»åŠ æ–°çš„æ–‡ä»¶ç±»å‹æ”¯æŒï¼Ÿ

**A:** åœ¨ `allowed-types` ä¸­æ·»åŠ æ‰©å±•åï¼š

```yaml
storage:
  allowed-types:
    - jpg
    - mp4 # æ·»åŠ è§†é¢‘æ”¯æŒ
    - mp3 # æ·»åŠ éŸ³é¢‘æ”¯æŒ
```

### Q5: æœ¬åœ°å­˜å‚¨çš„æ–‡ä»¶å¦‚ä½•è¿ç§»åˆ°äº‘å­˜å‚¨ï¼Ÿ

**A:**

1. ä¿®æ”¹é…ç½® `storage.type: qiniu`
2. é‡å¯åº”ç”¨
3. æ–°ä¸Šä¼ çš„æ–‡ä»¶å°†ä½¿ç”¨äº‘å­˜å‚¨
4. æ—§æ–‡ä»¶éœ€è¦æ‰‹åŠ¨è¿ç§»ï¼ˆå¯ç¼–å†™è¿ç§»è„šæœ¬ï¼‰

### Q6: å¦‚ä½•ç›‘æ§å­˜å‚¨æœåŠ¡çŠ¶æ€ï¼Ÿ

**A:** å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ç›‘æ§ï¼š

```java
@Autowired
private FileStorageConfig fileStorageConfig;

// æ£€æŸ¥é…ç½®çŠ¶æ€
boolean isValid = fileStorageConfig.isStorageConfigValid();
String configInfo = fileStorageConfig.getStorageConfigInfo();
```

### Q7: å¦‚ä½•é…ç½®æ–‡ä»¶è®¿é—®æƒé™ï¼Ÿ

**A:**

- **ä¸ƒç‰›äº‘**ï¼šé€šè¿‡ `url-expire-seconds` æ§åˆ¶ç§æœ‰æ–‡ä»¶è¿‡æœŸæ—¶é—´
- **æœ¬åœ°å­˜å‚¨**ï¼šé€šè¿‡ Spring Security æˆ–æ–‡ä»¶æœåŠ¡æ¥å£æ§åˆ¶è®¿é—®æƒé™

---

## ğŸš€ æœ€ä½³å®è·µ

1. **å®‰å…¨æ€§**

   - ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨æ•æ„Ÿä¿¡æ¯
   - å®šæœŸè½®æ¢ AccessKey å’Œ SecretKey
   - å¯ç”¨ HTTPS è®¿é—®

2. **æ€§èƒ½ä¼˜åŒ–**

   - ä¸ƒç‰›äº‘å¯ç”¨ CDN åŠ é€Ÿ
   - åˆç†è®¾ç½®æ–‡ä»¶å¤§å°é™åˆ¶
   - æœ¬åœ°å­˜å‚¨å¯ç”¨æ—¥æœŸç›®å½•åˆ†ç±»

3. **è¿ç»´ä¾¿åˆ©**

   - ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒé…ç½®æ–‡ä»¶
   - é…ç½®æ–‡ä»¶ç‰ˆæœ¬åŒ–ç®¡ç†
   - ç›‘æ§å­˜å‚¨ä½¿ç”¨æƒ…å†µ

4. **å®¹ç¾å¤‡ä»½**
   - é‡è¦æ–‡ä»¶å¤šåœ°å¤‡ä»½
   - æ”¯æŒå­˜å‚¨ç­–ç•¥çƒ­åˆ‡æ¢
   - å®šæœŸæµ‹è¯•é…ç½®æœ‰æ•ˆæ€§
