# æŠ€æœ¯é…ç½®è¯´æ˜æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†ä¸ªäººåšå®¢ç³»ç»Ÿä¸­å„é¡¹æŠ€æœ¯ç»„ä»¶çš„é…ç½®æ–¹æ³•ï¼ŒåŒ…æ‹¬ Redis ç¼“å­˜ã€Elasticsearch æœç´¢å¼•æ“å’Œä¸ƒç‰›äº‘å­˜å‚¨çš„é›†æˆæ–¹æ¡ˆã€‚

## âœ… Redis ç¼“å­˜é…ç½®ï¼ˆå·²å®Œæˆï¼‰

### 1. ä¾èµ–é…ç½®ï¼ˆå·²å®Œæˆï¼‰

```xml
<!-- pom.xmlä¸­å·²åŒ…å«ä»¥ä¸‹ä¾èµ– -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
<dependency>
    <groupId>redis.clients</groupId>
    <artifactId>jedis</artifactId>
</dependency>
<dependency>
    <groupId>org.apache.commons</groupId>
    <artifactId>commons-pool2</artifactId>
</dependency>
```

### 2. è¿æ¥é…ç½®ï¼ˆå·²å®Œæˆï¼‰

```properties
# RedisæœåŠ¡å™¨åœ°å€
spring.redis.host=119.29.213.93
spring.redis.port=6379
spring.redis.database=0
spring.redis.password=
spring.redis.timeout=3000
spring.redis.jedis.pool.max-active=20
spring.redis.jedis.pool.max-wait=-1
spring.redis.jedis.pool.max-idle=10
spring.redis.jedis.pool.min-idle=0
```

### 3. Redis ä½¿ç”¨åœºæ™¯

- **JWT ä»¤ç‰Œç¼“å­˜**ï¼šå­˜å‚¨ç”¨æˆ·ç™»å½•çŠ¶æ€
- **æ–‡ç« ç¼“å­˜**ï¼šçƒ­é—¨æ–‡ç« å†…å®¹ç¼“å­˜
- **è®¿é—®ç»Ÿè®¡**ï¼šé¡µé¢è®¿é—®æ¬¡æ•°ç»Ÿè®¡
- **éªŒè¯ç **ï¼šå›¾ç‰‡éªŒè¯ç ä¸´æ—¶å­˜å‚¨
- **é˜²é‡å¤æäº¤**ï¼šæ¥å£è¯·æ±‚é˜²é‡å¤

## âœ… ä¸ƒç‰›äº‘å­˜å‚¨é…ç½®ï¼ˆå·²å®Œæˆï¼‰

### 1. ä¾èµ–é…ç½®ï¼ˆå·²å®Œæˆï¼‰

```xml
<!-- pom.xmlä¸­å·²åŒ…å«ä»¥ä¸‹ä¾èµ– -->
<dependency>
    <groupId>com.qiniu</groupId>
    <artifactId>qiniu-java-sdk</artifactId>
    <version>[7.13.0, 7.13.99]</version>
</dependency>
```

### 2. é…ç½®æ–‡ä»¶è®¾ç½®ï¼ˆå·²å®Œæˆï¼‰

```properties
# ä¸ƒç‰›äº‘å­˜å‚¨é…ç½®
qiniu.access-key=SebyrzexqU_w28lVXy2O20emZJhA47ST5gE-Idnv
qiniu.secret-key=z1regMYgab8refVZ7Mu0NZHFACuqdP4bqTcxPPH8
qiniu.bucket-name=person-hzt
qiniu.region=huanan
qiniu.domain=your-cdn-domain.com
qiniu.s3-domain=person-hzt.s3.cn-south-1.qiniucs.com
qiniu.use-https=true

# æ–‡ä»¶ä¸Šä¼ é…ç½®
file.upload.max-size=10MB
file.upload.allowed-types=jpg,jpeg,png,gif,bmp,webp,pdf,doc,docx,xls,xlsx,ppt,pptx,txt,zip,rar
```

### 3. ä»£ç å®ç°ï¼ˆå·²å®Œæˆï¼‰

- âœ… `QiniuConfig.java` - ä¸ƒç‰›äº‘é…ç½®ç±»
- âœ… `FileStorageService.java` - æ–‡ä»¶å­˜å‚¨æœåŠ¡ï¼ˆçº¯ä¸ƒç‰›äº‘ï¼‰
- âœ… `FileUploadResult.java` - æ–‡ä»¶ä¸Šä¼ ç»“æœç±»
- âœ… `FileUploadController.java` - æ–‡ä»¶ä¸Šä¼ æ§åˆ¶å™¨

### 4. å­˜å‚¨ç‰¹æ€§

- **çº¯äº‘å­˜å‚¨**ï¼šæ‰€æœ‰æ–‡ä»¶ç›´æ¥ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘
- **è‡ªåŠ¨å‘½å**ï¼šUUID ç”Ÿæˆå”¯ä¸€æ–‡ä»¶åï¼Œé¿å…å†²çª
- **åˆ†æ¨¡å—å­˜å‚¨**ï¼šæ”¯æŒæŒ‰æ¨¡å—ç»„ç»‡æ–‡ä»¶ï¼ˆavatarã€articleã€attachment ç­‰ï¼‰
- **æ–‡ä»¶éªŒè¯**ï¼šæ”¯æŒæ–‡ä»¶å¤§å°ã€ç±»å‹éªŒè¯
- **æ•°æ®åº“è®°å½•**ï¼šå®Œæ•´çš„æ–‡ä»¶ä¿¡æ¯è®°å½•

### 5. API æ¥å£

- `POST /api/files/upload` - é€šç”¨æ–‡ä»¶ä¸Šä¼ 
- `POST /api/files/upload/avatar` - å¤´åƒä¸Šä¼ ï¼ˆé™åˆ¶å›¾ç‰‡ç±»å‹ï¼‰
- `GET /api/files/url/{fileId}` - è·å–æ–‡ä»¶è®¿é—® URL
- `DELETE /api/files/{fileId}` - åˆ é™¤æ–‡ä»¶

## ğŸ” Elasticsearch æœç´¢å¼•æ“é…ç½®ï¼ˆå¾…é…ç½®ï¼‰

### 1. ä¾èµ–é…ç½®ï¼ˆå·²å®Œæˆï¼‰

```xml
<!-- pom.xmlä¸­å·²åŒ…å«ä»¥ä¸‹ä¾èµ– -->
<dependency>
    <groupId>co.elastic.clients</groupId>
    <artifactId>elasticsearch-java</artifactId>
    <version>8.12.2</version>
</dependency>
<dependency>
    <groupId>org.elasticsearch.client</groupId>
    <artifactId>elasticsearch-rest-client</artifactId>
    <version>8.12.2</version>
</dependency>
```

### 2. é…ç½®æ­¥éª¤

#### 2.1 æ·»åŠ  Elasticsearch é…ç½®

```properties
# application.propertiesä¸­æ·»åŠ ä»¥ä¸‹é…ç½®
# Elasticsearché…ç½®
elasticsearch.host=localhost
elasticsearch.port=9200
elasticsearch.username=
elasticsearch.password=
elasticsearch.scheme=http
elasticsearch.connection-timeout=5000
elasticsearch.socket-timeout=30000
elasticsearch.connection-request-timeout=5000
```

#### 2.2 åˆ›å»º Elasticsearch é…ç½®ç±»

```java
@Configuration
public class ElasticsearchConfig {

    @Bean
    public ElasticsearchClient elasticsearchClient() {
        RestClient restClient = RestClient.builder(
            new HttpHost("localhost", 9200, "http")
        ).build();

        ElasticsearchTransport transport = new RestClientTransport(
            restClient, new JacksonJsonpMapper()
        );

        return new ElasticsearchClient(transport);
    }
}
```

#### 2.3 åˆ›å»ºæ–‡ç« ç´¢å¼•æ˜ å°„

```java
@Document(indexName = "article")
public class ArticleDocument {
    @Id
    private String id;
    private String title;
    private String content;
    private String summary;
    private List<String> tags;
    private String categoryName;
    private LocalDateTime createTime;
    // getters and setters
}
```

#### 2.4 åˆ›å»ºæœç´¢æœåŠ¡

```java
@Service
public class ArticleSearchService {

    @Autowired
    private ElasticsearchClient client;

    public SearchResult<ArticleDocument> searchArticles(String keyword, int page, int size) {
        // å®ç°æœç´¢é€»è¾‘
    }
}
```

### 3. ç´¢å¼•ç®¡ç†ç­–ç•¥

- **è‡ªåŠ¨åŒæ­¥**ï¼šæ–‡ç«  CRUD æ“ä½œæ—¶è‡ªåŠ¨åŒæ­¥åˆ° ES
- **æ‰¹é‡å¯¼å…¥**ï¼šå®šæ—¶ä»»åŠ¡æ‰¹é‡åŒæ­¥æ•°æ®
- **ç´¢å¼•ä¼˜åŒ–**ï¼šå®šæœŸä¼˜åŒ–ç´¢å¼•ç»“æ„

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. Redis ä¼˜åŒ–

- ä½¿ç”¨è¿æ¥æ± ç®¡ç†è¿æ¥
- è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
- ä½¿ç”¨ Pipeline æ‰¹é‡æ“ä½œ
- ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ

### 2. Elasticsearch ä¼˜åŒ–

- åˆç†è®¾è®¡ç´¢å¼•ç»“æ„
- ä½¿ç”¨æ‰¹é‡æ“ä½œ
- å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®
- ç›‘æ§é›†ç¾¤çŠ¶æ€

### 3. ä¸ƒç‰›äº‘å­˜å‚¨ä¼˜åŒ–

- CDN åŠ é€Ÿè®¿é—®
- å›¾ç‰‡å‹ç¼©å¤„ç†
- å®šæœŸæ¸…ç†æ— ç”¨æ–‡ä»¶
- å®ç°æ–‡ä»¶å»é‡

## ğŸ”§ éƒ¨ç½²é…ç½®

### 1. å¼€å‘ç¯å¢ƒ

- Redis: æœ¬åœ° Docker å®¹å™¨
- Elasticsearch: æœ¬åœ°å®‰è£…
- ä¸ƒç‰›äº‘: å·²é…ç½®å®Œæˆ

### 2. ç”Ÿäº§ç¯å¢ƒ

- Redis: é›†ç¾¤éƒ¨ç½²
- Elasticsearch: é›†ç¾¤éƒ¨ç½²
- ä¸ƒç‰›äº‘: ç”Ÿäº§ç©ºé—´

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **Redis å¯†ç **ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»è®¾ç½®å¯†ç 
2. **ES ç‰ˆæœ¬**ï¼šç¡®ä¿ç‰ˆæœ¬å…¼å®¹æ€§
3. **ä¸ƒç‰›äº‘é…ç½®**ï¼šå¯†é’¥å®‰å…¨ä¿å­˜ï¼ˆå·²é…ç½®ï¼‰
4. **CDN åŸŸå**ï¼šéœ€è¦ç»‘å®šè‡ªå®šä¹‰åŸŸå
5. **å®¹é‡ç›‘æ§**ï¼šå®šæœŸç›‘æ§å­˜å‚¨ä½¿ç”¨æƒ…å†µ

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

1. âœ… å®Œæˆä¸ƒç‰›äº‘å­˜å‚¨é…ç½®
2. âœ… å®ç°æ–‡ä»¶ä¸Šä¼ æœåŠ¡
3. âœ… åˆ›å»ºæ–‡ä»¶ç®¡ç† API
4. â³ é…ç½® CDN è‡ªå®šä¹‰åŸŸå
5. â³ é…ç½® Elasticsearch è¿æ¥
6. â³ é›†æˆæœç´¢åŠŸèƒ½åˆ°æ–‡ç« ç®¡ç†

## ğŸš€ æµ‹è¯•ä¸ƒç‰›äº‘ä¸Šä¼ 

### API æµ‹è¯•ç¤ºä¾‹

```bash
# ä¸Šä¼ æ–‡ä»¶
curl -X POST "http://localhost:8080/api/files/upload" \
  -H "Content-Type: multipart/form-data" \
  -F "file=@/path/to/your/file.jpg" \
  -F "module=test"

# ä¸Šä¼ å¤´åƒ
curl -X POST "http://localhost:8080/api/files/upload/avatar" \
  -H "Content-Type: multipart/form-data" \
  -F "file=@/path/to/avatar.jpg"

# è·å–æ–‡ä»¶URL
curl -X GET "http://localhost:8080/api/files/url/{fileId}"

# åˆ é™¤æ–‡ä»¶
curl -X DELETE "http://localhost:8080/api/files/{fileId}"
```

### æ–‡ä»¶å­˜å‚¨ç»“æ„

```
ä¸ƒç‰›äº‘å­˜å‚¨ç©ºé—´: person-hzt
â”œâ”€â”€ avatar/          # ç”¨æˆ·å¤´åƒ
â”œâ”€â”€ article/         # æ–‡ç« å›¾ç‰‡
â”œâ”€â”€ attachment/      # é™„ä»¶æ–‡ä»¶
â””â”€â”€ default/         # é»˜è®¤åˆ†ç±»
```
